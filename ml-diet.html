<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Nutrition Engine | FitCalc Dashboard</title>
    <link rel="stylesheet" href="assets/css/dashboard.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
</head>

<body>

    <div class="app-layout">
        <!-- 1. Top Navigation Bar (Restored) -->
        <header>
            <div class="container">
                <nav>
                    <div class="logo">FitCalc<span>.AI</span></div>
                    <ul class="nav-links">
                        <li><a href="calculator.html">Calories</a></li>
                        <li><a href="bmi-calculator.html">BMI</a></li>
                        <li><a href="ml-diet.html" class="active nav-highlight">AI Diet <span
                                    class="badge">NEW</span></a></li>
                        <li><a href="tracker.html">Tracker</a></li>
                        <!-- Language Switcher Inline -->
                        <li>
                            <select id="lang-switch"
                                style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.2rem; border-radius: 4px; font-size: 0.8rem;">
                                <option value="en" style="color: black;">EN</option>
                                <option value="hi" style="color: black;">HI</option>
                            </select>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- 2. Main Dashboard Content -->
        <main class="dashboard-content">

            <!-- Page Title Area -->
            <div
                style="margin-bottom: 2rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem; display: flex; justify-content: space-between; align-items: flex-end;">
                <div>
                    <h1
                        style="font-size: 2.5rem; font-weight: 800; background: linear-gradient(135deg, white, var(--text-muted)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        AI Nutrition Engine</h1>
                    <p style="color: var(--text-muted); margin-top: 0.5rem;">Powered by Advanced Machine Learning ‚Ä¢
                        Medically Safe ‚Ä¢ Personalized</p>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Left Panel: Input Configuration -->
                <section class="input-panel glass-card">
                    <h3 class="section-title">Your Profile</h3>

                    <div class="form-group">
                        <label for="age">Age</label>
                        <input type="number" id="age" value="25">
                    </div>

                    <div class="form-group">
                        <label for="height">Height (cm)</label>
                        <input type="number" id="height" value="175">
                    </div>

                    <div class="form-group">
                        <label>Weight (kg) <button type="button" onclick="syncWithTracker()"
                                style="background:none; border:none; color:var(--primary); font-size:0.8rem; cursor:pointer; margin-left: auto;">üîÑ
                                Sync Latest</button></label>
                        <input type="number" id="weight" placeholder="e.g. 75">
                    </div>

                    <div class="form-group">
                        <label>Gender</label>
                        <select id="gender">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Level</label>
                        <select id="activity">
                            <option value="Sedentary">Sedentary (Office Job)</option>
                            <option value="Lightly Active">Lightly Active (1-2 days/week)</option>
                            <option value="Moderately Active">Moderately Active (3-5 days/week)</option>
                            <option value="Very Active">Very Active (6-7 days/week)</option>
                            <option value="Extra Active">Extra Active (Physical Job)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Diet Preference</label>
                        <select id="diet">
                            <option value="Standard">Standard (Balanced)</option>
                            <option value="Vegetarian">Vegetarian</option>
                            <option value="Vegan">Vegan</option>
                            <option value="Keto">Keto (Low Carb)</option>
                            <option value="Indian-Vegetarian">Indian (Vegetarian)</option>
                            <option value="Indian-Non-Vegetarian">Indian (Non-Vegetarian)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Health Goal</label>
                        <select id="goal">
                            <option value="Maintenance">Maintenance</option>
                            <option value="Weight Loss">Weight Loss</option>
                            <option value="Extreme Weight Loss">Extreme Weight Loss</option>
                            <option value="Weight Gain">Weight Gain</option>
                            <option value="Muscle Gain">Muscle Gain</option>
                        </select>
                    </div>

                    <button class="btn-generate" onclick="predict()">GENERATE PLAN ‚ú®</button>
                    <div id="loading"
                        style="display:none; text-align: center; margin-top: 1rem; color: var(--primary);">
                        ‚è≥ AI is thinking...
                    </div>
                </section>

                <!-- Right Panel: Results Area -->
                <section class="results-panel" id="results-area" style="display: none;">

                    <!-- Safety Alert Box -->
                    <div id="safety-alert" class="glass-card"
                        style="display:none; border-color: var(--accent); margin-bottom: 2rem; background: rgba(255, 0, 85, 0.1);">
                        <h4 style="color: var(--accent); margin-bottom: 0.5rem;">‚ö†Ô∏è Health Safety Adjustment</h4>
                        <p id="safety-msg" style="font-size: 0.9rem;">Your calories were adjusted for safety.</p>
                    </div>

                    <div class="stats-row">
                        <!-- Main Calorie Card -->
                        <div class="stat-card glass-card">
                            <h3 class="section-title" style="margin-bottom: 0.5rem; text-align: center; border: none;">
                                Daily Target</h3>
                            <div class="big-number" id="res-cals">0</div>
                            <p style="color: var(--text-muted); font-size: 0.9rem;">Calories / Day</p>
                        </div>

                        <!-- Macro Chart -->
                        <div class="glass-card" style="display: flex; flex-direction: column; justify-content: center;">
                            <div class="meal-header" style="margin-bottom: 0.5rem; border: none; padding: 0;">
                                <span class="meal-title">Protein</span>
                                <span class="meal-cals" id="res-p">0g</span>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="bar-p" style="width: 0%; height: 100%; background: #00F0FF;"></div>
                            </div>

                            <div class="meal-header"
                                style="margin-top: 1rem; margin-bottom: 0.5rem; border: none; padding: 0;">
                                <span class="meal-title">Carbs</span>
                                <span class="meal-cals" id="res-c">0g</span>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="bar-c" style="width: 0%; height: 100%; background: #FF0055;"></div>
                            </div>

                            <div class="meal-header"
                                style="margin-top: 1rem; margin-bottom: 0.5rem; border: none; padding: 0;">
                                <span class="meal-title">Fats</span>
                                <span class="meal-cals" id="res-f">0g</span>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="bar-f" style="width: 0%; height: 100%; background: #7000FF;"></div>
                            </div>
                        </div>

                        <!-- Info Card -->
                        <div class="glass-card"
                            style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                            <h4 style="color: var(--primary);">AI Analysis</h4>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 1rem;">
                                Based on your profile, this plan balances sustainability with your goal.
                                <br><br>
                                <button onclick="generatePDF()"
                                    style="background: var(--glass-border); border: none; padding: 0.5rem 1rem; color: white; border-radius: 8px; cursor: pointer;">Download
                                    PDF üì•</button>
                            </p>
                        </div>
                    </div>

                    <!-- Meal Plan Section -->
                    <h3 class="section-title" style="margin-bottom: 1.5rem;">Recommended Meal Plan</h3>

                    <div id="ai-meal-plan" style="display: none;">
                        <div id="meals-container" class="meals-grid">
                            <!-- Meals injected by JS -->
                        </div>
                    </div>

                    <div id="error-box" class="glass-card"
                        style="display:none; border-color: var(--accent); color: var(--accent); margin-top: 2rem; text-align: center;">
                        <h3>‚ö†Ô∏è Connection Error</h3>
                        <p>Ensure `python3 app.py` is running!</p>
                    </div>

                </section>
            </div>
        </main>
    </div>

    <!-- Recipe Modal -->
    <div id="recipe-modal"
        style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center;">
        <div class="glass-card"
            style="width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative;">
            <span onclick="closeRecipe()"
                style="position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer;">&times;</span>
            <h2 id="modal-meal-name" style="color: var(--primary); margin-bottom: 1rem;">Meal Name</h2>

            <h4 style="color: var(--text-muted);">Ingredients</h4>
            <ul id="modal-ingredients" style="margin-bottom: 1.5rem; color: white; padding-left: 1.5rem;"></ul>

            <h4 style="color: var(--text-muted);">Instructions</h4>
            <ol id="modal-instructions" style="color: white; padding-left: 1.5rem;"></ol>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/i18n.js"></script>
    <script>
        // 1. Sync Weight Logic
        function syncWithTracker() {
            const history = JSON.parse(localStorage.getItem('weightHistory')) || [];
            if (history.length === 0) {
                alert("No weight data found in tracker!");
                return;
            }
            // Sort by date descending
            history.sort((a, b) => new Date(b.date) - new Date(a.date));
            const latest = history[0];
            document.getElementById('weight').value = latest.weight;
            alert(`Synced! Latest weight: ${latest.weight}kg (${latest.date})`);
        }

        // 2. Animate Counter
        function animateCounter(element, target, duration = 1500) {
            const start = 0;
            const increment = target / (duration / 16);
            let current = start;
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    element.textContent = Math.round(target);
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current);
                }
            }, 16);
        }

        // 3. Main Predict Function
        async function predict() {
            const btn = document.querySelector('.btn-generate');
            const load = document.getElementById('loading');
            const resArea = document.getElementById('results-area');
            const errBox = document.getElementById('error-box');

            // Inputs
            const weight = parseFloat(document.getElementById('weight').value);
            const age = parseInt(document.getElementById('age').value);
            const height = parseFloat(document.getElementById('height').value);

            if (!weight || !age || !height) {
                alert("Please fill in all fields correctly.");
                return;
            }

            // UI State
            btn.disabled = true;
            btn.style.opacity = "0.5";
            load.style.display = 'block';
            resArea.style.display = 'none';
            errBox.style.display = 'none';

            const payload = {
                weight_kg: weight,
                age: age,
                height_cm: height,
                gender: document.getElementById('gender').value,
                activity_level: document.getElementById('activity').value,
                dietary_preference: document.getElementById('diet').value,
                health_goal: document.getElementById('goal').value
            };

            try {
                // Use config for API URL
                const apiUrl = `${config.API_BASE_URL}/predict`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();

                // Safety msg
                const safetyAlert = document.getElementById('safety-alert');
                if (data.recalibration_msg) {
                    safetyAlert.style.display = 'block';
                    document.getElementById('safety-msg').innerText = data.recalibration_msg;
                } else {
                    safetyAlert.style.display = 'none';
                }

                // Update Numbers
                resArea.style.display = 'block';
                const calsEl = document.getElementById('res-cals');
                animateCounter(calsEl, data.daily_calories);

                document.getElementById('res-p').innerText = data.macros.protein_g + 'g';
                document.getElementById('res-c').innerText = data.macros.carbs_g + 'g';
                document.getElementById('res-f').innerText = data.macros.fat_g + 'g';

                // Simple Bars
                const totalCals = data.daily_calories;
                document.getElementById('bar-p').style.width = ((data.macros.protein_g * 4) / totalCals * 100) + '%';
                document.getElementById('bar-c').style.width = ((data.macros.carbs_g * 4) / totalCals * 100) + '%';
                document.getElementById('bar-f').style.width = ((data.macros.fat_g * 9) / totalCals * 100) + '%';

                // Meal Plan
                const mealBox = document.getElementById('ai-meal-plan');
                const mealsContainer = document.getElementById('meals-container');

                if (data.meal_plan && data.meal_plan.meals) {
                    window.currentMealPlan = data.meal_plan; // Global store
                    mealBox.style.display = 'block';

                    const mealIcons = { 'Breakfast': 'üåÖ', 'Lunch': '‚òÄÔ∏è', 'Dinner': 'üåô', 'Snack': 'üçé', 'Snacks': 'üçé' };

                    mealsContainer.innerHTML = data.meal_plan.meals.map((meal, mIdx) => `
                        <div class="meal-card">
                            <div class="meal-header">
                                <span class="meal-title"><span style="margin-right:0.5rem; font-size:1.2rem;">${mealIcons[meal.meal_type] || 'üçΩÔ∏è'}</span> ${meal.meal_type}</span>
                            </div>
                            <ul style="list-style: none;">
                                ${meal.items.map((item, iIdx) => `
                                    <li style="margin-bottom: 0.8rem; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.5rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.2rem;">
                                            <span style="color: white; font-weight: 500;">${item.food}</span>
                                            <span class="meal-cals">${item.calories}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted);">
                                            <span>${item.quantity}</span>
                                            <span style="cursor: pointer; color: var(--primary);" onclick="openRecipe(${mIdx}, ${iIdx})">View Recipe ‚Üó</span>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `).join('');
                } else {
                    mealBox.style.display = 'none';
                }

            } catch (err) {
                console.error(err);
                errBox.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.style.opacity = "1";
                load.style.display = 'none';
            }
        }

        // 4. Modal Logic
        function openRecipe(mealIdx, itemIdx) {
            if (!window.currentMealPlan) return;
            const item = window.currentMealPlan.meals[mealIdx].items[itemIdx];

            document.getElementById('modal-meal-name').innerText = item.food;
            const ingList = document.getElementById('modal-ingredients');
            const instList = document.getElementById('modal-instructions');

            ingList.innerHTML = (item.ingredients || ["Data not available"]).map(i => `<li>${i}</li>`).join('');
            instList.innerHTML = (item.instructions || ["Data not available"]).map(i => `<li>${i}</li>`).join('');

            document.getElementById('recipe-modal').style.display = 'flex';
        }

        function closeRecipe() {
            document.getElementById('recipe-modal').style.display = 'none';
        }

        // Advanced PDF Generation
        function generatePDF() {
            const element = document.getElementById('results-area');
            const btn = document.querySelector('button[onclick="generatePDF()"]');

            // Visual Feedback
            const originalText = btn.innerText;
            btn.innerText = "Generating PDF... ‚è≥";
            btn.disabled = true;

            // Apply specific PDF styles temporarily
            element.classList.add('pdf-mode');

            // Options for robust generation
            const opt = {
                margin: 0.5,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // Generate with explicit filename in save
            html2pdf().set(opt).from(element).save('My_FitCalc_Plan.pdf')
                .then(() => {
                    // Cleanup
                    element.classList.remove('pdf-mode');
                    btn.innerText = originalText;
                    btn.disabled = false;
                })
                .catch(err => {
                    console.error("PDF Error:", err);
                    alert("PDF Generation Failed. Please try again or check console.");
                    element.classList.remove('pdf-mode');
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
        }
    </script>
</body>

</html>